<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>XML Grid Field Generator</title>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 16px;
        background: #f7f7f7;
    }
    textarea, input {
        width: 100%;
        box-sizing: border-box;
        margin: 6px 0;
        padding: 6px;
    }
    textarea {
        min-height: 160px;
        font-family: Consolas, monospace;
    }
    button {
        padding: 8px 16px;
        margin: 6px 0;
        cursor: pointer;
    }
    .box {
        background: #fff;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    .rule {
        font-size: 13px;
        background: #eef;
        padding: 10px;
        border-radius: 6px;
        line-height: 1.5;
    }
</style>
</head>

<body>

<h2>XML Grid Field Generator</h2>

<div class="box rule">
<b>Quy tắc:</b><br>
- name có <b>ngay</b> → dataType="D", align="Center", width=100<br>
- name có <b>so</b> hoặc <b>sl</b> → dataType="N", format="Qty"<br>
- name có <b>gc_</b> → width=250<br>
- Cột Excel: <b>name | v1 | v2 | width | dataType | format | align</b><br>
- width / dataType / format / align: nếu trống → tự áp quy tắc<br>
- v2 trống → dùng v1<br>
</div>

<div class="box">
<b>Google Sheet (public CSV link)</b>
<input id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
<button onclick="loadFromSheet()">Load từ Google Sheet</button>
</div>

<div class="box">
<b>Hoặc upload file Excel (.xlsx)</b>
<input type="file" id="fileInput" accept=".xlsx">
</div>

<div class="box">
<b>Kết quả XML</b>
<button onclick="copyXML()">Copy XML</button>
<textarea id="output"></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
function applyRule(col) {
    let width = col.width || '';
    let dataType = col.dataType || '';
    let format = col.format || '';
    let align = col.align || '';

    const name = col.name.toLowerCase();

    if (!width) {
        if (name.includes('gc_')) width = 250;
        else if (name.includes('ngay')) width = 100;
        else width = 120;
    }

    if (!dataType) {
        if (name.includes('ngay')) dataType = 'D';
        else if (name.includes('so') || name.includes('sl')) dataType = 'N';
        else dataType = 'S';
    }

    if (!format && dataType === 'N') {
        format = 'Qty';
    }

    if (!align && name.includes('ngay')) {
        align = 'Center';
    }

    return { width, dataType, format, align };
}

function generateXML(rows) {
    let xml = '';
    rows.forEach(r => {
        if (!r.name) return;

        const rule = applyRule(r);
        const v1 = r.v1 || '';
        const v2 = r.v2 || v1;

        xml += `<field name="${r.name}" width="${rule.width}" dataType="${rule.dataType}"`;
        if (rule.format) xml += ` format="${rule.format}"`;
        if (rule.align) xml += ` align="${rule.align}"`;
        xml += `>\n`;
        xml += `  <text v="${v1}" e="${v2}" o="${v2}"/>\n`;
        xml += `</field>\n\n`;
    });

    document.getElementById('output').value = xml.trim();
}

function parseSheetData(data) {
    const headers = data[0].map(h => h.toLowerCase());
    const rows = [];

    for (let i = 1; i < data.length; i++) {
        const row = {};
        headers.forEach((h, idx) => {
            row[h] = data[i][idx];
        });
        rows.push(row);
    }
    generateXML(rows);
}

async function loadFromSheet() {
    const url = document.getElementById('sheetUrl').value.trim();
    if (!url) return alert('Nhập link Google Sheet');

    try {
        const res = await fetch(url);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(','));
        parseSheetData(rows);
    } catch (e) {
        alert('Không load được Google Sheet. Phải publish CSV và chạy qua GitHub Pages.');
    }
}

document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
        parseSheetData(data);
    };
    reader.readAsBinaryString(file);
});

function copyXML() {
    const ta = document.getElementById('output');
    ta.select();
    document.execCommand('copy');
}
</script>

</body>
</html>
