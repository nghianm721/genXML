<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>XML Grid Field Generator</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 16px;
    background: #f5f5f5;
}
textarea, input {
    width: 100%;
    box-sizing: border-box;
    margin: 6px 0;
    padding: 6px;
}
textarea {
    min-height: 220px;
    font-family: Consolas, monospace;
}
button {
    padding: 8px 16px;
    margin-top: 6px;
    cursor: pointer;
}
.box {
    background: #fff;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
}
.rule {
    background: #eef;
    font-size: 13px;
    line-height: 1.5;
}
</style>
</head>

<body>

<h2>XML Grid Field Generator</h2>

<div class="box rule">
<b>Quy tắc:</b><br>
- Excel columns: <b>name | v1 | v2 | width | datatype | format | align</b><br>
- Excel nhập gì → ưu tiên tuyệt đối<br>
- Không nhập → mới áp rule<br>
- name có <b>ngay</b> → width=100, align=Center<br>
- name có <b>so</b> hoặc <b>sl</b> → dataType=N, format=Qty<br>
- name có <b>gc_</b> → width=250<br>
- Không có dataType → <b>KHÔNG sinh attribute</b>
</div>

<div class="box">
<b>Google Sheet (CSV public)</b>
<input id="sheetUrl"
value="https://docs.google.com/spreadsheets/d/e/2PACX-1vR8xLFEg4CNb7qWveE6lG6aGPR6gHtm56uGs_0heFRzj2w0K9ntQlEiZCM4PI6bVO9-MHQd0vnKwYFV/pub?gid=0&single=true&output=csv">
<button onclick="loadFromSheet()">Load Google Sheet</button>
</div>

<div class="box">
<b>Hoặc upload Excel (.xlsx)</b>
<input type="file" id="fileInput" accept=".xlsx">
</div>

<div class="box">
<b>Kết quả XML</b><br>
<button onclick="copyXML()">Copy XML</button>
<textarea id="output"></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
function normalize(v) {
    return v === undefined || v === null ? '' : String(v).trim();
}

function applyRule(row) {
    let name = row.name.toLowerCase();

    const widthFromExcel    = normalize(row.width);
    const dataTypeFromExcel = normalize(row.datatype);
    const formatFromExcel   = normalize(row.format);
    const alignFromExcel    = normalize(row.align);

    let width   = widthFromExcel;
    let dataType = dataTypeFromExcel;
    let format  = formatFromExcel;
    let align   = alignFromExcel;

    // WIDTH
    if (!width) {
        if (name.includes('gc_')) width = '250';
        else if (name.includes('ngay')) width = '100';
        else width = '120';
    }

    // DATATYPE
    if (!dataType) {
        if (name.includes('ngay')) dataType = 'D';
        else if (name.includes('so') || name.includes('sl')) dataType = 'N';
    }

    // FORMAT (CHỈ KHI CẢ datatype & format ĐỀU TRỐNG)
    if (!format && !dataTypeFromExcel) {
        if (dataType === 'N') format = 'Qty';
    }

    // ALIGN (EXCEL ƯU TIÊN TUYỆT ĐỐI)
    if (!align && name.includes('ngay')) {
        align = 'Center';
    }

    return { width, dataType, format, align };
}

function generateXML(rows) {
    let xml = '';

    rows.forEach(r => {
        if (!r.name) return;

        const rule = applyRule(r);
        const v1 = normalize(r.v1);
        const v2 = normalize(r.v2) || v1;

        xml += `<field name="${r.name}" width="${rule.width}"`;

        if (rule.dataType) xml += ` dataType="${rule.dataType}"`;
        if (rule.format)   xml += ` format="${rule.format}"`;
        if (rule.align)    xml += ` align="${rule.align}"`;

        xml += `>\n`;
        xml += `  <text v="${v1}" e="${v2}" o="${v2}"/>\n`;
        xml += `</field>\n\n`;
    });

    document.getElementById('output').value = xml.trim();
}

function parseTable(data) {
    const headers = data[0].map(h => h.toLowerCase());
    const rows = [];

    for (let i = 1; i < data.length; i++) {
        const row = {};
        headers.forEach((h, idx) => {
            row[h] = data[i][idx];
        });
        rows.push(row);
    }
    generateXML(rows);
}

async function loadFromSheet() {
    const url = document.getElementById('sheetUrl').value;
    try {
        const res = await fetch(url);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(','));
        parseTable(rows);
    } catch {
        alert('Không load được Google Sheet (phải chạy qua GitHub Pages)');
    }
}

document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
        parseTable(data);
    };
    reader.readAsBinaryString(file);
});

function copyXML() {
    const ta = document.getElementById('output');
    ta.select();
    document.execCommand('copy');
}
</script>

</body>
</html>


